<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Video Script Generator</title>
<style>
  body {margin:0;font-family:Arial;background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);color:white;}
  .container{background:#111;padding:25px;width:100%;max-width:600px;border-radius:12px;margin:30px auto;box-shadow:0 20px 40px rgba(0,0,0,0.5);}
  h1,h2{text-align:center;}
  label{display:block;margin-top:10px;}
  input,select,textarea{width:100%;padding:10px;margin-top:5px;border-radius:6px;border:none;outline:none;background:#222;color:white;}
  button{margin-top:10px;padding:12px;width:100%;border:none;border-radius:6px;background:#00c6ff;font-weight:bold;cursor:pointer;}
  button:hover{background:#009edc;}
  #chatBox{max-height:400px;overflow-y:auto;margin-top:15px;padding:10px;background:#222;border-radius:8px;}
  .chatMessage{margin-bottom:10px;padding:8px;border-radius:6px;}
  .user{background:#009edc;color:white;}
  .ai{background:#444;color:white;}
  .editable{background:#333;padding:5px;border-radius:4px;margin:5px 0;width:100%;color:white;border:none;}
  #imageContainer{display:flex;flex-wrap:wrap;gap:10px;margin-top:15px;}
  #imageContainer img{max-width:100px;border-radius:8px;}
  #logoutBtn{background:#ff5555;}
</style>
</head>
<body>

<!-- LOGIN BOX -->
<div id="loginBox" class="container">
  <h2>Login / Signup</h2>
  <label>Email:</label>
  <input type="email" id="email" placeholder="Enter email">
  <label>Password:</label>
  <div style="position:relative;">
    <input type="password" id="password" placeholder="Enter password" style="width:100%; padding-right:40px;">
    <button type="button" id="togglePassword" style="position:absolute; right:5px; top:5px; background:none; border:none; color:#00c6ff; cursor:pointer;">üëÅÔ∏è</button>
  </div>
  <button onclick="login()">Login</button>
  <button onclick="signup()">Sign Up</button>
  <div id="loginReminder" style="color:#ff5555; margin-top:10px;">Please log in to use AI features.</div>
</div>

<!-- MAIN AI CONTAINER -->
<div id="mainContainer" class="container" style="display:none;">
  <h1>AI Video Generator</h1>
  
  <!-- FORM -->
  <form id="aiForm">
    <label>Topic</label>
    <input id="topic" placeholder="Enter video topic" required>
    <label>Video Type</label>
    <select id="videoType">
      <option value="Short">Short</option>
      <option value="Long">Long</option>
    </select>
    <label>Tone</label>
    <input id="tone" placeholder="Friendly, Professional, etc">
    <label>Generate Image?</label>
    <select id="generateImage">
      <option value="Yes">Yes</option>
      <option value="No">No</option>
    </select>
    <label>Number of Images</label>
    <input id="imageCount" type="number" min="1" max="5" value="1">
    <button type="submit">Generate All</button>
  </form>
  
  <button id="logoutBtn" onclick="logout()">Logout</button>

  <!-- CHAT AREA -->
  <div id="chatBox"></div>

  <!-- IMAGE DISPLAY -->
  <div id="imageContainer"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCwumS1PZH4aKpKBMhmDiNXMyp9zgPm0JY",
  authDomain: "ai-video-generator-562af.firebaseapp.com",
  projectId: "ai-video-generator-562af",
  storageBucket: "ai-video-generator-562af.firebasestorage.app",
  messagingSenderId: "299293689534",
  appId: "1:299293689534:web:3a62b8233ff0b02401c0ef"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

// Show/Hide password
document.getElementById("togglePassword").addEventListener("click", ()=>{
  const pwd = document.getElementById("password");
  pwd.type = pwd.type==="password"?"text":"password";
});

// Signup
window.signup = () => {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  if(!email || !password){alert("Enter email and password"); return;}
  createUserWithEmailAndPassword(auth,email,password)
  .then(()=>alert("Account created ‚úÖ"))
  .catch(err=>alert(err.message));
};

// Login
window.login = () => {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  if(!email || !password){alert("Enter email and password"); return;}
  signInWithEmailAndPassword(auth,email,password)
  .then(()=>alert("Logged in ‚úÖ"))
  .catch(err=>alert(err.message));
};

// Logout
window.logout = () => { 
  signOut(auth).then(()=>alert("Logged out ‚úÖ")); 
};

// Monitor login
onAuthStateChanged(auth, user=>{
  const loginBox = document.getElementById("loginBox");
  const mainContainer = document.getElementById("mainContainer");
  loginBox.style.display = user?"none":"block";
  mainContainer.style.display = user?"block":"none";
});

// CHAT & IMAGE HANDLER
const chatBox = document.getElementById("chatBox");
const imageContainer = document.getElementById("imageContainer");

function addChatMessage(type,text,editable=false,key=""){
  const div = document.createElement("div");
  div.className="chatMessage "+type;
  if(editable){
    const ta = document.createElement("textarea");
    ta.value=text;
    ta.className="editable";
    ta.onblur = ()=>{ updateField(key, ta.value); addChatMessage("ai",`Updated ${key} ‚úÖ`); };
    div.appendChild(ta);
  } else div.textContent=text;
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}

// Submit form
document.getElementById("aiForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const user = auth.currentUser;
  if(!user){alert("‚ö†Ô∏è Login first!"); return;}

  const payload = {
    topic: document.getElementById("topic").value,
    video_type: document.getElementById("videoType").value,
    tone: document.getElementById("tone").value,
    generate_image: document.getElementById("generateImage").value,
    image_count: document.getElementById("imageCount").value,
    user_id: user.uid
  };

  addChatMessage("user",`Submitted: ${payload.topic}`);
  addChatMessage("ai","Generating content...");

  // Zapier webhook
  fetch("https://hooks.zapier.com/hooks/catch/26044546/ugc49fb/",{
    method:"POST",mode:"no-cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)
  });

  // Free AI image generation (Craiyon)
  if(payload.generate_image==="Yes"){
    imageContainer.innerHTML="";
    for(let i=0;i<parseInt(payload.image_count);i++){
      const img = document.createElement("img");
      img.src=`https://api.craiyon.com/generate?prompt=${encodeURIComponent(payload.topic+" "+payload.tone)}&num_images=1`;
      imageContainer.appendChild(img);
    }
  }
});

// Update field (send to Zapier)
function updateField(key,value){
  const user = auth.currentUser;
  if(!user) return;
  fetch("https://hooks.zapier.com/hooks/catch/26044546/ugc49fb/",{
    method:"POST",mode:"no-cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:user.uid,key,value})
  });
}

// Auto-refresh chat every 10s
setInterval(async()=>{
  const user = auth.currentUser;
  if(!user) return;
  // Fetch latest data
  const res = await fetch("https://spreadsheets.google.com/feeds/list/2PACX-1vS9GDPobHDyoNMlFaY2_sXsBUYLoFtugV337QnsZ1_peM1AzNYZc5-dcKsl8OZ4y8Zh0afqdnYgbV1T/od6/public/values?alt=json");
  const data = await res.json();
  const entries = data.feed.entry.map(item=>({
    topic:item.gsx$topic.$t,
    video_type:item.gsx$videotype.$t,
    tone:item.gsx$tone.$t,
    script:item.gsx$script?.$t||"",
    voiceover:item.gsx$voiceoverscript?.$t||"",
    thumbnail:item.gsx$thumbnail?.$t||"",
    image_prompt:item.gsx$imageprompt?.$t||"",
    user_id:item.gsx$userid.$t
  }));
  const userData = entries.find(d=>d.user_id===user.uid);
  if(userData){
    chatBox.innerHTML="";
    addChatMessage("ai",`Topic: ${userData.topic}`,true,"topic");
    addChatMessage("ai",`Video Type: ${userData.video_type}`,true,"video_type");
    addChatMessage("ai",`Tone: ${userData.tone}`,true,"tone");
    addChatMessage("ai",`Script: ${userData.script}`,true,"script");
    addChatMessage("ai",`Voiceover: ${userData.voiceover}`,true,"voiceover");
    addChatMessage("ai",`Thumbnail Prompt: ${userData.thumbnail}`,true,"thumbnail");
    addChatMessage("ai",`Image Prompt: ${userData.image_prompt}`,true,"image_prompt");
  }
},10000);

</script>
</body>
</html>
